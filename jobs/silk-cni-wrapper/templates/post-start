#!/bin/bash



while curl localhost:23954; do
 if [ $? -eq 0 ]; then
   SILK_CIDR=$(curl -s localhost:23954 | cut -f4 -d'"')
   break;
 else
   sleep 1;
 fi

done
SERVICE_NETWORK_CIDR="$(cat /var/vcap/jobs/kube-proxy/config/config.yml | grep '^clusterCIDR' | cut -f2 -d' ')"
iptables -F INPUT
iptables -F OUTPUT
# ALLOW ALL TRAFFIC ON KUBE MASTER
<% if_link("kubernetes-workers") do |instances| %>
  <% instances.instances.map do |instance| %>
iptables -I INPUT  -s "$SILK_CIDR" -d "$(dig +short <%= instance.address %>)" -j ACCEPT
  <% end %>
<% end %>
iptables -I OUTPUT  -s "$SILK_CIDR" -d "0.0.0.0/0" -o eth0 -j ACCEPT

# ALLOW ALL TRAFFIC ON KUBE MASTER
<% if_link("kube-apiserver") do |instances| %>
  <% instances.instances.map do |instance| %>
iptables -A INPUT  -s "$SILK_CIDR" -d "$(dig +short <%= instance.address %>)" -j ACCEPT
  <% end %>
<% end %>


# ALLOW ALL TRAFFIC ON SERVICE NETWORK OF KUBE_PROXY/KUBERNETES SERVICES
iptables -A INPUT  -s "$SILK_CIDR" -d "$SERVICE_NETWORK_CIDR" -j ACCEPT
iptables -A OUTPUT  -s "$SILK_CIDR" -d "$SERVICE_NETWORK_CIDR" -j ACCEPT
iptables -A FORWARD -s "$SILK_CIDR" -d "0.0.0.0/0" -o eth0 -j ACCEPT

